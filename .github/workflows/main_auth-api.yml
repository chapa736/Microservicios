# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy ASP.Net Core app to Azure Web App - auth-api

on:
  push:
    branches:
      - main
    paths:
      - 'src/Auth/**'  # Solo se ejecuta cuando cambia algo en Auth
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'  # Actualizado a .NET 8.0

      - name: Restore dependencies
        run: dotnet restore src/Auth/Auth.WebAPI/Auth.API.csproj

      - name: Build Auth.API
        run: dotnet build src/Auth/Auth.WebAPI/Auth.API.csproj --configuration Release --no-restore

      - name: Publish Auth.API (SOLO este proyecto)
        run: |
          dotnet publish src/Auth/Auth.WebAPI/Auth.API.csproj \
            --configuration Release \
            --no-build \
            --output ./publish-auth \
            --framework net8.0 \
            --self-contained false \
            /p:PublishReadyToRun=false \
            /p:CopyLocalLockFileAssemblies=true

      - name: Verificar qué se publicó
        run: |
          echo "=== Archivos en publish-auth ==="
          ls -la ./publish-auth/ | head -30
          echo ""
          echo "=== DLLs publicados ==="
          ls -la ./publish-auth/*.dll 2>/dev/null | head -20 || echo "No hay DLLs"
          echo ""
          echo "=== Verificando Microsoft.AspNetCore.Authentication.JwtBearer ==="
          if [ -f "./publish-auth/Microsoft.AspNetCore.Authentication.JwtBearer.dll" ]; then
            echo "✅ Microsoft.AspNetCore.Authentication.JwtBearer.dll encontrado"
            ls -lh ./publish-auth/Microsoft.AspNetCore.Authentication.JwtBearer.dll
          else
            echo "❌ ERROR: Microsoft.AspNetCore.Authentication.JwtBearer.dll NO encontrado"
            find ./publish-auth -name "*JwtBearer*" -type f || echo "No encontrado en ningún lugar"
            exit 1
          fi
          echo ""
          echo "=== Verificando que NO haya archivos de Seguros ==="
          if find ./publish-auth -name "*Seguros*" -type f | grep -q .; then
            echo "⚠️ ADVERTENCIA: Se encontraron archivos de Seguros"
            find ./publish-auth -name "*Seguros*" -type f
          else
            echo "✅ OK: No hay archivos de Seguros"
          fi

      - name: Eliminar archivos de Seguros (si existen)
        run: |
          cd ./publish-auth
          rm -f Seguros.API.dll Seguros.API.pdb Seguros.API.deps.json Seguros.API.runtimeconfig.json
          rm -f Seguros.Application.* Seguros.Core.* Seguros.Domain.* Seguros.Infrastructure.*
          find . -maxdepth 1 -name "*Seguros*" -type f -delete 2>/dev/null || true
          echo "=== Archivos después de limpiar ==="
          ls -la *.dll 2>/dev/null | head -20 || echo "No hay DLLs"

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ./publish-auth

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app
          path: ./publish-auth
      
      - name: Verificar contenido antes de deploy
        run: |
          echo "=== Archivos que se van a desplegar ==="
          ls -la ./publish-auth/ | head -30
          echo ""
          echo "=== Verificando que NO haya Seguros.API.dll ==="
          if [ -f "./publish-auth/Seguros.API.dll" ]; then
            echo "ERROR: Seguros.API.dll todavía existe"
            exit 1
          else
            echo "✅ OK: No hay Seguros.API.dll"
          fi
          echo ""
          echo "=== Verificando Microsoft.AspNetCore.Authentication.JwtBearer ==="
          if [ -f "./publish-auth/Microsoft.AspNetCore.Authentication.JwtBearer.dll" ]; then
            echo "✅ Microsoft.AspNetCore.Authentication.JwtBearer.dll encontrado"
          else
            echo "❌ ERROR: Microsoft.AspNetCore.Authentication.JwtBearer.dll NO encontrado"
            exit 1
          fi
          echo ""
          echo "=== Verificando Auth.API.dll ==="
          if [ -f "./publish-auth/Auth.API.dll" ]; then
            echo "✅ Auth.API.dll encontrado"
          else
            echo "❌ ERROR: Auth.API.dll NO encontrado"
            exit 1
          fi
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_60FE3B67180448119C14C6F787553FA8 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_234147D1968D4D539DCD0433244139D5 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_D722DAF3ADD34B3FAA9BBA71E00C2594 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'auth-api'
          slot-name: 'Production'
          package: ./publish-auth

          

